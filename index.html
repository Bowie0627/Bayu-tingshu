<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<title>巴渝听书 · 川渝方言（必成版）</title>
<style>
  body{font-family:Microsoft YaHei;background:#f5f5f5;padding:20px}
  .box{max-width:900px;margin:0 auto;background:#fff;padding:30px;border-radius:15px;box-shadow:0 8px 30px rgba(0,0,0,0.1)}
  h1{color:#d32f2f;text-align:center;font-size:38px}
  textarea{width:100%;height:320px;padding:15px;font-size:18px;border:2px solid #ddd;border-radius:10px}
  .btns{margin:20px 0;display:flex;gap:15px;flex-wrap:wrap;align-items:center}
  select,button{padding:12px 20px;font-size:16px;border-radius:8px}
  button{cursor:pointer;color:#fff;border:none;font-weight:bold}
  #preview{background:#0066cc}
  #gen{background:#d32f2f}
  #dl{background:#0a8c2a;opacity:0.5;pointer-events:none}
  #dl.ok{opacity:1;pointer-events:auto}
  #msg{margin-left:15px;font-weight:bold;color:#d32f2f}
</style>
</head>
<body>
<div class="box">
  <h1>巴渝听书</h1>
  <textarea id="txt" placeholder="输入任何文字，马上用正宗四川话读出来（爪子、巴适、要得、莫得问题……）"></textarea>
  
  <div class="btns">
    <select id="v">
      <option value="川渝男生">川渝男生（最正宗四川话）</option>
      <option value="老汉儿">老汉儿（重庆味）</option>
      <option value="川渝女生">川渝女生</option>
    </select>
    <button id="preview">试听前200字</button>
    <button id="gen">生成完整语音</button>
    <button id="dl">下载MP3</button>
    <span id="msg">就绪</span>
  </div>
  
  <audio id="player" controls style="width:100%;margin-top:20px;display:none"></audio>
</div>

<script>
async function go(text, voice) {
  if (!text.trim()) return alert("请输入文字");
  document.getElementById("msg").textContent = "生成中…（10-30秒）";
  document.getElementById("gen").disabled = true;
  
  try {
    const r = await fetch("http://127.0.0.1:5000/tts", {
      method: "POST",
      headers: {"Content-Type":"application/json"},
      body: JSON.stringify({text: text, voice: voice})
    });
    
    const json = await r.json();
    console.log("后端返回：", json);   // ← 这行很重要！打开 F12 能看到真实错误
    
    if (json.audio_url) {
      const url = "http://127.0.0.1:5000" + json.audio_url;
      const p = document.getElementById("player");
      p.src = url;
      p.style.display = "block";
      p.play();
      document.getElementById("msg").textContent = "生成成功！正在播放";
      document.getElementById("dl").classList.add("ok");
      document.getElementById("dl").onclick = ()=> {location.href = url + "?download=1"};
    } else {
      document.getElementById("msg").textContent = "失败：" + json.error;
    }
  } catch (e) {
    document.getElementById("msg").textContent = "连接失败（但后端可能其实在跑）";
    console.error(e);
  }
  document.getElementById("gen").disabled = false;
}

document.getElementById("preview").onclick = () => go(document.getElementById("txt").value.slice(0,200) || "爪子哦，试听一下四川话，巴适得板！", document.getElementById("v").value);
document.getElementById("gen").onclick     = () => go(document.getElementById("txt").value || "爪子哦，今天要去撸串串，巴适惨了！", document.getElementById("v").value);
</script>
</body>
</html>